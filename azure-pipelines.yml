# Azure DevOps Pipeline (Alternative to GitHub Actions)
# Use this if you prefer Azure DevOps over GitHub Actions

trigger:
  branches:
    include:
    - main
    - develop
  paths:
    exclude:
    - README.md
    - docs/*

pr:
  branches:
    include:
    - main

variables:
  pythonVersion: '3.8'
  azureSubscription: 'Azure-Service-Connection'
  webAppName: 'sampro-interview-system'
  resourceGroup: 'interview-system-rg'

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: CodeQuality
    displayName: 'Code Quality Check'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
      displayName: 'Use Python $(pythonVersion)'
    
    - script: |
        python -m pip install --upgrade pip
        pip install black flake8 pylint
      displayName: 'Install linting tools'
    
    - script: |
        black --check backend/
      displayName: 'Run Black'
      continueOnError: true
    
    - script: |
        flake8 backend/ --count --statistics
      displayName: 'Run Flake8'
      continueOnError: true

  - job: UnitTests
    displayName: 'Unit Tests'
    dependsOn: CodeQuality
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
    
    - script: |
        pip install -r backend/requirements.txt
        pip install -r backend/requirements_free_ai.txt
        pip install pytest pytest-cov
      displayName: 'Install dependencies'
    
    - script: |
        pytest backend/tests/ -v --cov=backend/src --cov-report=xml
      displayName: 'Run tests'
      env:
        HF_API_KEY_1: $(HF_API_KEY_1)
        GROQ_API_KEY_1: $(GROQ_API_KEY_1)
    
    - task: PublishCodeCoverageResults@1
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'

  - job: SecurityScan
    displayName: 'Security Scan'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
    
    - script: |
        pip install safety bandit
        pip install -r backend/requirements.txt
      displayName: 'Install security tools'
    
    - script: |
        safety check
      displayName: 'Run Safety'
      continueOnError: true
    
    - script: |
        bandit -r backend/ -f json -o bandit-report.json
      displayName: 'Run Bandit'
      continueOnError: true
    
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: 'bandit-report.json'
        artifactName: 'security-reports'

  - job: BuildPackage
    displayName: 'Build Deployment Package'
    dependsOn: [UnitTests, SecurityScan]
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'
    
    - script: |
        mkdir -p $(Build.ArtifactStagingDirectory)/deploy
        cp -r backend $(Build.ArtifactStagingDirectory)/deploy/
        cp -r frontend $(Build.ArtifactStagingDirectory)/deploy/
      displayName: 'Create deployment package'
    
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)/deploy'
        artifactName: 'drop'

- stage: DeployStaging
  displayName: 'Deploy to Staging'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
  - deployment: DeployStaging
    displayName: 'Deploy to Staging Environment'
    environment: 'staging'
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              artifactName: 'drop'
          
          - task: AzureWebApp@1
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: '$(webAppName)-staging'
              package: '$(System.ArtifactsDirectory)/drop'
              deploymentMethod: 'zipDeploy'
          
          - script: |
              sleep 30
              curl -f https://$(webAppName)-staging.azurewebsites.net/health
            displayName: 'Smoke Test'

- stage: DeployProduction
  displayName: 'Deploy to Production'
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - deployment: DeployProduction
    displayName: 'Deploy to Production Environment'
    environment: 'production'
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              artifactName: 'drop'
          
          - task: AzureWebApp@1
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: '$(webAppName)'
              package: '$(System.ArtifactsDirectory)/drop'
              deploymentMethod: 'zipDeploy'
              slotName: 'production'
          
          - script: |
              sleep 30
              curl -f https://$(webAppName).azurewebsites.net/health
            displayName: 'Smoke Test'
          
          - script: |
              echo "Load test would run here"
            displayName: 'Load Test'
            continueOnError: true
