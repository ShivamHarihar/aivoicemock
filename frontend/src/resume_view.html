{% extends "base.html" %}

{% block title %}Resume Preview | SAMPRO AI{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <!-- Header with Back Button -->
        <div class="page-header fade-up" style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h1>Your Optimized Resume</h1>
                <p class="subtitle" id="template-name-subtitle">Previewing Template</p>
            </div>
            <a href="/recreate_resume_page" class="btn btn-outline">
                ‚Üê Back to Templates
            </a>
        </div>

        <div class="fade-up">
            <!-- Toolbar -->
            <!-- Toolbar -->
            <div class="preview-toolbar"
                style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1rem;">

                <div class="download-actions" style="position: relative;">
                    <button class="btn btn-primary" id="download-dropdown-btn" onclick="toggleDownloadDropdown(event)">
                        üìÑ Download Resume ‚ñº
                    </button>
                    <div id="download-dropdown"
                        style="display: none; position: absolute; right: 0; background: #1f2937; border: 1px solid rgba(99,102,241,0.3); border-radius: 8px; margin-top: 8px; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.5); min-width: 200px;">
                        <button onclick="downloadResume('pdf'); hideDownloadDropdown();"
                            style="width: 100%; padding: 14px 20px; background: transparent; color: #e5e7eb; border: none; text-align: left; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);"
                            onmouseover="this.style.background='rgba(99,102,241,0.2)'"
                            onmouseout="this.style.background='transparent'">
                            üìÑ Download as PDF
                        </button>
                        <button onclick="downloadResume('docx'); hideDownloadDropdown();"
                            style="width: 100%; padding: 14px 20px; background: transparent; color: #e5e7eb; border: none; text-align: left; cursor: pointer;"
                            onmouseover="this.style.background='rgba(99,102,241,0.2)'"
                            onmouseout="this.style.background='transparent'">
                            üìù Download as Word
                        </button>
                    </div>
                </div>
            </div>

            <div class="recreated-content">
                <div id="preview-content" class="format-content active" style="display: block;">
                    <div id="resume-preview" class="resume-preview"></div>
                </div>
            </div>

        </div>
    </div>
</section>

<!-- Include Scripts -->
<script src="/static/js/template_preview.js"></script>
<script src="/static/js/dropdown_functions.js"></script>
<script>
    // Inline script to handle parameters and loading
    document.addEventListener('DOMContentLoaded', function () {
        // Get template ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const templateId = urlParams.get('template') || 'template-1';

        // Update subtitle
        const cleanName = templateId.replace('template-', 'Template ').replace(/^\w/, c => c.toUpperCase());
        document.getElementById('template-name-subtitle').textContent = `Previewing ${cleanName} Design`;

        // Load Content
        loadResumeContent(templateId);
    });

    function loadResumeContent(templateId) {
        const dataStr = sessionStorage.getItem('recreated_resume_content');
        if (!dataStr) {
            window.location.href = '/recreate_resume_page';
            return;
        }

        const result = JSON.parse(dataStr);
        window.recreatedResumeData = result;

        // 1. Show Loading
        const previewEl = document.getElementById('resume-preview');
        previewEl.innerHTML = '<div class="preview-loading" style="color:#000; text-align:center; padding-top:100px;">Generating High-Quality PDF Preview...<br><span style="font-size:0.8em; opacity:0.7">This may take a moment</span></div>';

        // 2. Fetch PDF Blob
        fetch('/api/generate_preview_pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                markdown_text: result.resume_markdown,
                template_id: templateId
            })
        })
            .then(response => {
                if (!response.ok) throw new Error('Preview generation failed');
                return response.blob();
            })
            .then(blob => {
                // 3. Create Blob URL
                const url = URL.createObjectURL(blob);

                // 4. Render Iframe
                previewEl.innerHTML = `
                <iframe 
                    src="${url}" 
                    style="width: 100%; height: 100%; min-height: 800px; border: none; border-radius: 8px;"
                    type="application/pdf"
                >
                    <p>Your browser does not support PDFs. 
                       <a href="${url}" target="_blank">Download the PDF</a> to view it.
                    </p>
                </iframe>
            `;
            })
            .catch(err => {
                console.error(err);
                previewEl.innerHTML = `<div style="color:#ef4444; padding:20px; text-align:center;">
                <h3>Preview Error</h3>
                <p>${err.message}</p>
                <p>Please try referencing the page or selecting a different template.</p>
            </div>`;
            });
    }



    function downloadResume(format) {
        if (!window.recreatedResumeData) return;

        const urlParams = new URLSearchParams(window.location.search);
        const templateId = urlParams.get('template') || 'template-1';
        const data = window.recreatedResumeData;

        // Logic similar to recreate_resume_page.js but simpler
        const endpoint = format === 'pdf' ? '/api/download_resume_pdf' : '/api/download_resume_docx';
        const btn = document.getElementById('download-dropdown-btn');
        const originalText = btn.textContent;
        btn.textContent = '‚è≥ Processing...';
        btn.disabled = true;

        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                markdown_text: data.resume_markdown,
                template_id: templateId
            })
        })
            .then(async res => {
                if (!res.ok) throw new Error('Generation failed');
                return res.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `resume_${templateId}.${format === 'pdf' ? 'pdf' : 'docx'}`;
                a.click();
                URL.revokeObjectURL(url);
                btn.textContent = originalText;
                btn.disabled = false;
            })
            .catch(err => {
                alert(err.message);
                btn.textContent = originalText;
                btn.disabled = false;
            });
    }
</script>

<style>
    /* Re-use styles from recreate_resume or similar */
    .section {
        padding: 20px 0 !important;
        /* Reduce default section padding */
        background: transparent !important;
        /* Remove grey bg */
    }

    .container {
        max-width: 98% !important;
        /* Use almost full screen width */
        padding: 0 20px;
    }

    .resume-preview {
        width: 100%;
        height: 88vh;
        /* Maximize height */
        overflow: hidden;
        /* Removed padding and bg to let iframe fill */
        padding: 0;
        background: transparent;
        display: flex;
        justify-content: center;
        border-radius: 8px;
    }
</style>
{% endblock %}